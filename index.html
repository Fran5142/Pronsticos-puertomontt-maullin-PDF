<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convertidor PDF</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: linear-gradient(135deg, #001f3f, #013a63, #014f86);
  color: #000;
}

h1, h2 {
  text-align: center;
  color: #fff;
  font-size: 26px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 25px;
  text-shadow: 0 0 8px rgba(0,0,0,0.3);
}

#textoInforme {
  width: 80%;
  height: 200px;
  margin: 0 auto 20px auto;
  padding: 12px;
  font-family: Arial, sans-serif;
  font-size: 14px;
  border: 2px solid #014f86;
  border-radius: 10px;
  background: #fff;
  color: #000;
  resize: none;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.4);
  display: block;
}

button {
  margin: 10px 5px;
  padding: 12px 20px;
  font-weight: bold;
  font-size: 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.25s ease-in-out;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
}

button:hover { transform: translateY(-2 px); }

.btn-vista { background: #00b4d8; color: #001f3f; }
.btn-vista:hover { background: #90e0ef; }

.btn-pdf { background: #e63946; color: #fff; }
.btn-pdf:hover { background: #ff5c66; }

.btn-reiniciar { background: #2a9d8f; color: #fff; }
.btn-reiniciar:hover { background: #52b2a5; }

#vistaPrevia {
  width: 210mm;
  min-height: 297mm;
  background: #fff;
  color: #000;
  margin: 30px auto;
  padding: 20mm 20mm 30mm 20mm;
  font-family: Arial, sans-serif;
  font-size: 12pt;
  line-height: 1.35;
  text-align: justify;
}

.encabezado-principal {
  font-size: 18pt;
  font-weight: bold;
  text-align: center;
  text-transform: uppercase;
  margin-top: -10px;
  margin-bottom: 4px;
  color: #000;
}

.parrafo-libre {
  text-align: center;
  font-weight: bold;
  margin: 0;
  padding: 0;
  line-height: 1.1;
  color: #000;
}

.negrita {
  font-weight: bold;
  color: #000;
}

.bloque-temp {
  display: block;
  margin: 12px 0;
  font-weight: bold;
  text-transform: uppercase;
  line-height: 1.1;
  color: #000;
  text-align: justify;
}

.bloque-editable-bajo {
  font-weight: bold;
  text-align: left;
  margin-top: 25px;
  margin-bottom: -23px;
  margin-left: -1px;
  outline: 1px dashed #999;
  padding: 0px;
  background: #fff;
  color: #000;
  display: block;
  width: 95%;
  border-radius: 6px;
  box-sizing: border-box;
}
.bloque-editable-bajo:focus { outline: 2px solid #00b4d8; background: #f1f1f1; }

.dia-semana { display: block; text-align: center; font-weight: bold; text-decoration: underline; font-size: 14pt; margin: 22px 0 6px 0; color: #000; line-height: 1.1; }
.bloque-seccion { margin: 6px 0 12px 0; line-height: 1.25; text-align: justify; color: #000; }
.titulo-seccion { font-weight: bold; display: block; margin-bottom: 3px; font-size: 13pt; color: #000; text-decoration: underline; }

footer { text-align: center; color: #e0e0e0; font-size: 13px; margin-top: 40px; letter-spacing: 0.5px; opacity: 0.85; }
footer span { font-weight: bold; color: #90e0ef; font-size: 16px; }

.config input#nombrePDF {
  width: 250px;
  padding: 12px 16px;
  font-size: 14pt;
  font-weight: 500;
  border: 2px solid #f0c987;
  border-radius: 12px;
  outline: none;
  background: #fff8e7;
  color: #4a4a4a;
  box-shadow: 0 4px 8px rgba(0,0,0,0.08);
  transition: all 0.3s ease-in-out;
}

.config input#nombrePDF:focus {
  border-color: #f7b733;
  background: #fff3d6;
  box-shadow: 0 6px 12px rgba(0,0,0,0.12); 
}

.config.oculta { display: none; }

#emitido {
  margin-top: 10px;
}

.linea-prog {
  display: grid;
  grid-template-columns: 320px auto;
  column-gap: 10px;
  margin-bottom: 4px;
}

.linea-prog .etiqueta {
  font-weight: bold;
}

.linea-prog .valor {
  font-weight: bold;
}
</style>
</head>

<body>

<h1>Convertidor de Informe Meteorol√≥gico a PDF</h1>
<h2>(Puerto Montt y Maull√≠n)</h2>

<textarea id="textoInforme" placeholder="Pega aqu√≠ tu informe meteorol√≥gico en may√∫sculas..."></textarea>

<div class="config oculta">
  <label>Palabras que deben mantenerse SIEMPRE en may√∫sculas (separadas por comas):</label>
  <input type="text" id="palabrasMayus" value="MET008FF, MET106MD, N, S, E, W, NE, SE, NW, SW, N/NW, N/NE, S/SE, S/SW, E/SE, W/SW, NW/W, PM, AM">
</div>

<div class="config" style="text-align:center; margin-bottom:20px;">
  <label style="font-weight:bold; font-size:14pt; color:#fff;">Nombre sugerido para PDF:</label><br>
  <input type="text" id="nombrePDF" placeholder="Ej: Informe_Meteorologico">
</div>

<div style="text-align:center;">
  <button class="btn-vista" onclick="generarVista()">üîç Ver vista previa</button>
  <button class="btn-pdf" onclick="generarPDF()">üìÑ Generar PDF</button>
  <button class="btn-reiniciar" onclick="reiniciar()">üîÑ Reiniciar</button>
</div>

<div id="vistaPrevia"></div>

<footer>
  Creado por <span>Cabo 2¬∫ (Met.) Francisco Salas Mu√±oz</span>
</footer>

<script>
// --- FUNCIONES EXISTENTES ---
function capitalizarFrase(str){
  str = str.toLowerCase().replace(/(^|[.!?\n]\s*)([a-z√°√©√≠√≥√∫√±])/g, (m,sep,letra)=>sep+letra.toUpperCase());
  str = str.replace(/\bAm\b/g,'AM');
  str = str.replace(/\bPm\b/g,'PM');
  return str;
}

function reemplazarAbreviaturas(texto){
  texto = texto.replace(/\bVIS\b/gi,'visibilidad');
  texto = texto.replace(/\bVTO\b/gi,'viento');
  texto = texto.replace(/\bCALMA\b/gi,'Calma'); 
  texto = texto.replace(/\bGOLFO CORONADOS\b/gi,'Golfo Coronados');
  texto = texto.replace(/\bPM\b/gi,'PM');
  texto = texto.replace(/\bAM\b/gi,'AM');

  texto = texto.replace(/\bBAHIA\b/gi,'bah√≠a');
  texto = texto.replace(/\bMIERCOLES\b/gi,'Mi√©rcoles');




  return texto;
}

function corregirTildesContexto(texto) {

  // 1Ô∏è‚É£ ANTICICL√ìNICO al inicio de frase
  texto = texto.replace(
    /(^|[.!?\n]\s*)(ANTICICLONICO)\b/gi,
    (m, inicio) => `${inicio}Anticicl√≥nico`
  );

  // 2Ô∏è‚É£ anticicl√≥nico dentro de la frase
  texto = texto.replace(
    /\bANTICICLONICO\b/gi,
    "anticicl√≥nico"
  );

  return texto;
}


function corregirDireccionesViento(texto) {
  const direccionesMayus = [
    "N", "S", "E", "W",
    "NE", "SE", "NW", "SW",
    "N/NW", "N/NE", "S/SE", "S/SW", "E/SE", "W/SW", "NW/W"
  ];
  direccionesMayus.forEach(dir => {
    const regex = new RegExp("\\b" + dir + "\\b", "gi");
    texto = texto.replace(regex, dir);
  });
  const direccionesTexto = {
    "NORTE": "Norte",
    "SUR": "Sur",
    "ESTE": "Este",
    "WESTE": "Weste",
    "NORESTE": "Noreste",
    "NORWESTE": "Norweste",
    "SURESTE": "Sureste",
    "SURWESTE": "Surweste"
  };
  for (const [clave, valor] of Object.entries(direccionesTexto)) {
    const regex = new RegExp("\\b" + clave + "\\b", "gi");
    texto = texto.replace(regex, valor);
  }
  return texto;
}

function formatearTexto(texto){
  texto = capitalizarFrase(texto);
  texto = reemplazarAbreviaturas(texto);
  texto = corregirDireccionesViento(texto);
  texto = corregirTildesContexto(texto); // üëà AQU√ç

  texto = texto.replace(/\(mal\s+tiempo\)/gi, '<span class="negrita">(MAL TIEMPO)</span>');
  texto = texto.replace(/\(temporal\)/gi, '<span class="negrita">(TEMPORAL)</span>');

  texto = texto.replace(
    /\bEMITIDO:\s*([^\n]+)/gi,
    (match, resto) => {
      let limpio = resto.trim().toUpperCase();
      return `<div id="emitido"><span class="negrita">EMITIDO:</span> ${limpio}</div>`;
    }
  );

  const palabras = document.getElementById("palabrasMayus").value.split(',').map(p => p.trim());
  palabras.forEach(p => {
    if(p.startsWith("MET")) {
      const regex = new RegExp('\\b' + p + '\\b','gi');
      texto = texto.replace(regex, `<br><span class="negrita">${p}</span>`);
    }
  });

  texto = texto.replace(/\bPRONOSTICO VALIDO DESDE:?[^\n]*HORA LOCAL\.?/gi, 
    `<div class="bloque-editable-bajo" contenteditable="true">(pega aqu√≠ tu texto especial)</div>`);

  const espacioMin = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  const espacioMax = "&#8201;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  const espacioUV  = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";

  function bloqueNegrita(etiqueta, valor, espacios) {
    return `<b>${etiqueta.toUpperCase()}${espacios}: ${valor.toUpperCase()}</b>`;
  }

  texto = texto.replace(
    /\n?\s*(TEMPERATURA\s+MINIMA\s+PROBABLE)\s*:\s*([0-9]+¬∞[cC])/gi,
    (m, etiqueta, valor) => "<br><br>" + bloqueNegrita(etiqueta, valor, espacioMin)
  );

  texto = texto.replace(
    /\n?\s*(TEMPERATURA\s+MAXIMA\s+PROBABLE)\s*:\s*([0-9]+¬∞[cC])/gi,
    (m, etiqueta, valor) => "<br>" + bloqueNegrita(etiqueta, valor, espacioMax)
  );

  texto = texto.replace(
    /\n?\s*(INDICE\s+DE\s+RADIACION\s+ULTRAVIOLETA)\s*:\s*([0-9+]+(?:\s*[‚Äì\-]\s*[0-9+]+)?\s*[A-Z√Å√â√ç√ì√ö√ë]+(?:\s[A-Z√Å√â√ç√ì√ö√ë]+)*\s*\(FUENTE\s+DMC\)\.?)/gi,
    (m, etiqueta, valor) => {
      return "<br><b>" + etiqueta.toUpperCase() + espacioUV + ": " + valor.toUpperCase() + "</b>";
    }
  );

  return texto;
}

function aplicarFormatoHTML(texto){
  let html = texto;
  html = html.replace(/\b(Lunes|Martes|Mi√©rcoles|Miercoles|Jueves|Viernes|S√°bado|Sabado|Domingo)\s+\d{1,2}(\s+de\s+\w+)?\.?/gi,
    match => `<div class="dia-semana"><b><u>${capitalizarFrase(match.replace(/\./g,"").trim())}</u></b></div>`);
  html = html.replace(/\bSITUACION SINOPTICA:?[\s\n]*/gi,'<div class="bloque-seccion"><span class="titulo-seccion">Situaci√≥n Sin√≥ptica:</span>');
  html = html.replace(/\bPRONOSTICO:?[\s\n]*/gi,'</div><div class="bloque-seccion"><span class="titulo-seccion">Pron√≥stico:</span>');
  html += '</div>';
  html = html.replace(/\n{2,}/g,'\n');
  html = html.replace(/\n/g,'<br>');
  return html;
}

function generarVista(){
  const texto = document.getElementById("textoInforme").value.trim();
  if(!texto){ alert("Por favor, pega el texto del informe meteorol√≥gico."); return; }

  const lineas = texto.split("\n");
const encabezado = `<div class="encabezado-principal" style="margin-bottom:15px;">${lineas[0]}</div>` +
                   `<div class="encabezado-principal">${lineas[1]}</div>`;


  const espacioEntre2y3 = `<div style="height:18px;"></div>`;

  const libres = lineas.slice(2,5)
    .map(l => `<div class="parrafo-libre">${l}</div>`)
    .join("");
  const resto = lineas.slice(5).join("\n");

  const textoProcesado = formatearTexto(resto);
  const htmlFormateado = aplicarFormatoHTML(textoProcesado);

  document.getElementById("vistaPrevia").innerHTML =
    `${encabezado}${espacioEntre2y3}${libres}<br>${htmlFormateado}`;
}

// --- FUNCI√ìN MODIFICADA PARA PDF M√ÅS LIVIANO ---
async function generarPDF(){
  const { jsPDF } = window.jspdf;
  const vista = document.getElementById("vistaPrevia");

  // Reducir escala y fondo blanco
  const canvas = await html2canvas(vista,{scale:2, backgroundColor:"#ffffff"});

  // Convertir a JPEG con compresi√≥n 70%
  const imgData = canvas.toDataURL("image/jpeg", 0.7);

  const pdf = new jsPDF("p","mm","letter");
  const pageWidth = 216;
  const imgWidth = 210;
  let imgHeight = (canvas.height*imgWidth)/canvas.width;
  let position = 10;

  if(imgHeight > 280){ 
    imgHeight = 280; 
  }

  const nombreArchivo = document.getElementById("nombrePDF").value.trim() || "Informe_Meteorologico";
  pdf.addImage(imgData,"JPEG",(pageWidth-imgWidth)/2,position,imgWidth,imgHeight);
  pdf.save(nombreArchivo+".pdf");
}

function reiniciar(){
  document.getElementById("textoInforme").value = "";
  document.getElementById("vistaPrevia").innerHTML = "";
  document.getElementById("nombrePDF").value = "";
}
</script>
</body>
</html>

