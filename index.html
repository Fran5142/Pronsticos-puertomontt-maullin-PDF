<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convertidor PDF</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: linear-gradient(135deg, #001f3f, #013a63, #014f86);
  color: #000;
}

h1, h2 {
  text-align: center;
  color: #fff;
  font-size: 26px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 25px;
  text-shadow: 0 0 8px rgba(0,0,0,0.3);
}

#textoInforme {
  width: 80%;
  height: 200px;
  margin: 0 auto 20px auto;
  padding: 12px;
  font-family: Arial, sans-serif;
  font-size: 14px;
  border: 2px solid #014f86;
  border-radius: 10px;
  background: #fff;
  color: #000;
  resize: none;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.4);
  display: block;
}

button {
  margin: 10px 5px;
  padding: 12px 20px;
  font-weight: bold;
  font-size: 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.25s ease-in-out;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
}

button:hover { transform: translateY(-2px); }

.btn-vista { background: #00b4d8; color: #001f3f; }
.btn-vista:hover { background: #90e0ef; }

.btn-pdf { background: #e63946; color: #fff; }
.btn-pdf:hover { background: #ff5c66; }

.btn-reiniciar { background: #2a9d8f; color: #fff; }
.btn-reiniciar:hover { background: #52b2a5; }

#vistaPrevia {
  width: 210mm;
  min-height: 297mm;
  background: #fff;
  color: #000;
  margin: 30px auto;
  padding: 20mm 40mm 40mm 40mm;
  font-family: Arial, sans-serif;
  font-size: 12pt;
  line-height: 1.35;
  text-align: justify;
}

.encabezado-principal {
  font-size: 18pt;
  font-weight: bold;
  text-align: center;
  text-transform: uppercase;
  margin-top: -10px;
  margin-bottom: 4px;
  color: #000;
}

.parrafo-libre {
  text-align: center;
  font-weight: bold;
  margin: 0;
  padding: 0;
  line-height: 1.1;
  color: #000;
}

.negrita {
  font-weight: bold;
  color: #000;
}

.bloque-temp {
  display: block;
  margin: 12px 0;
  font-weight: bold;
  text-transform: uppercase;
  line-height: 1.1;
  color: #000;
  text-align: justify;
}

.bloque-editable-bajo {
  font-weight: bold;
  text-align: left;
  margin-top: 25px;
  margin-bottom: -25px;
  margin-left: -6px;
  outline: 1px dashed #999;
  padding: 6px;
  background: #fff;
  color: #000;
  display: block;
  width: 95%;
  border-radius: 6px;
  box-sizing: border-box;
}
.bloque-editable-bajo:focus { outline: 2px solid #00b4d8; background: #f1f1f1; }

.dia-semana { display: block; text-align: center; font-weight: bold; text-decoration: underline; font-size: 14pt; margin: 22px 0 6px 0; color: #000; line-height: 1.1; }
.bloque-seccion { margin: 6px 0 12px 0; line-height: 1.25; text-align: justify; color: #000; }
.titulo-seccion { font-weight: bold; display: block; margin-bottom: 3px; font-size: 13pt; color: #000; text-decoration: underline; }

footer { text-align: center; color: #e0e0e0; font-size: 13px; margin-top: 40px; letter-spacing: 0.5px; opacity: 0.85; }
footer span { font-weight: bold; color: #90e0ef; font-size: 16px; }

.config input#nombrePDF {
  width: 250px;
  padding: 12px 16px;
  font-size: 14pt;
  font-weight: 500;
  border: 2px solid #f0c987;
  border-radius: 12px;
  outline: none;
  background: #fff8e7;
  color: #4a4a4a;
  box-shadow: 0 4px 8px rgba(0,0,0,0.08);
  transition: all 0.3s ease-in-out;
}

.config input#nombrePDF:focus {
  border-color: #f7b733;
  background: #fff3d6;
  box-shadow: 0 6px 12px rgba(0,0,0,0.12); 
}

.config.oculta { display: none; }
</style>
</head>

<body>

<h1>Convertidor de Informe Meteorol칩gico a PDF</h1>
<h2>(Puerto Montt y Maull칤n)</h2>

<textarea id="textoInforme" placeholder="Pega aqu칤 tu informe meteorol칩gico en may칰sculas..."></textarea>

<!-- Configuraci칩n oculta -->
<div class="config oculta">
  <label>Palabras que deben mantenerse SIEMPRE en may칰sculas (separadas por comas):</label>
  <input type="text" id="palabrasMayus" value="MET008FF, MET106MD, N, S, E, W, NE, SE, NW, SW, N/NW, N/NE, S/SE, S/SW, E/SE, W/SW, NW/W, PM, AM">
</div>

<div class="config" style="text-align:center; margin-bottom:20px;">
  <label style="font-weight:bold; font-size:14pt; color:#fff;">Nombre sugerido para PDF:</label><br>
  <input type="text" id="nombrePDF" placeholder="Ej: Informe_Meteorologico">
</div>

<div style="text-align:center;">
  <button class="btn-vista" onclick="generarVista()">游댌 Ver vista previa</button>
  <button class="btn-pdf" onclick="generarPDF()">游늯 Generar PDF</button>
  <button class="btn-reiniciar" onclick="reiniciar()">游댃 Reiniciar</button>
</div>

<div id="vistaPrevia"></div>

<footer>
  Creado por <span>Cabo 2췈 (Met.) Francisco Salas Mu침oz</span>
</footer>

<script>
function capitalizarFrase(str){
  str = str.toLowerCase().replace(/(^|[.!?\n]\s*)([a-z치칠칤칩칰침])/g, (m,sep,letra)=>sep+letra.toUpperCase());
  str = str.replace(/\bAm\b/g,'AM');
  str = str.replace(/\bPm\b/g,'PM');
  return str;
}

function reemplazarAbreviaturas(texto){
  texto = texto.replace(/\bVIS\b/gi,'visibilidad');
  texto = texto.replace(/\bVTO\b/gi,'viento');
  texto = texto.replace(/\bCALMA\b/gi,'Calma'); 
  texto = texto.replace(/\bGOLFO CORONADOS\b/gi,'Golfo Coronados');
  texto = texto.replace(/\bPM\b/gi,'PM');
  texto = texto.replace(/\bAM\b/gi,'AM');


  texto=texto.replace(/\bCENTRO\b/gi,'Centro');
  texto=texto.replace(/\bMETEOROLOGICO\b/gi,'Meteorol칩gico');
  texto=texto.replace(/\bMARITIMO\b/gi,'Mar칤timo');
  texto=texto.replace(/\bPUERTO\b/gi,'Puerto');
  texto=texto.replace(/\bMONTT\b/gi,'Montt');
  return texto;
}

function corregirDireccionesViento(texto) {
  // 游댳 Asegura may칰sculas exactas en direcciones compuestas
  const direccionesMayus = [
    "N", "S", "E", "W",
    "NE", "SE", "NW", "SW",
    "N/NW", "N/NE", "S/SE", "S/SW", "E/SE", "W/SW", "NW/W"
  ];

  direccionesMayus.forEach(dir => {
    const regex = new RegExp("\\b" + dir + "\\b", "gi");
    texto = texto.replace(regex, dir);
  });

  // 游댳 Corrige nombres de direcciones escritas completas
  const direccionesTexto = {
    "NORTE": "Norte",
    "SUR": "Sur",
    "ESTE": "Este",
    "OESTE": "Oeste",
    "NORESTE": "Noreste",
    "NOROESTE": "Noroeste",
    "SURESTE": "Sureste",
    "SUROESTE": "Suroeste"
  };

  for (const [clave, valor] of Object.entries(direccionesTexto)) {
    const regex = new RegExp("\\b" + clave + "\\b", "gi");
    texto = texto.replace(regex, valor);
  }

  return texto;
}

function formatearTexto(texto){
  texto = capitalizarFrase(texto);
  texto = reemplazarAbreviaturas(texto);
  texto = corregirDireccionesViento(texto);

  texto = texto.replace(/\(mal\s+tiempo\)/gi, '<span class="negrita">(MAL TIEMPO)</span>');
  texto = texto.replace(/\(temporal\)/gi, '<span class="negrita">(TEMPORAL)</span>');
  texto = texto.replace(/\bEmitido:?/gi, '<span class="negrita">Emitido:</span>');

  const palabras = document.getElementById("palabrasMayus").value.split(',').map(p => p.trim());
  palabras.forEach(p => {
    if(p.startsWith("MET")) {
      const regex = new RegExp('\\b' + p + '\\b','gi');
      texto = texto.replace(regex, `<br><span class="negrita">${p}</span>`);
    }
  });

  texto = texto.replace(/\bPRONOSTICO VALIDO DESDE:?[^\n]*HORA LOCAL\.?/gi, 
    `<div class="bloque-editable-bajo" contenteditable="true">(pega aqu칤 tu texto especial)</div>`);

  texto = texto.replace(/(TEMPERATURA\s+MINIMA\s+PROBABLE\s*:\s*[0-9]+춿[cC])/gi, 
      (match) => `<br><span class="negrita">TEMPERATURAMINIMAPROBABLE:${match.split(':')[1].toUpperCase()}</span>`);

  texto = texto.replace(/(TEMPERATURA\s+MAXIMA\s+PROBABLE\s*:\s*[0-9]+춿[cC])/gi, 
      (match) => `<span class="negrita">TEMPERATURAMAXIMAPROBABLE:${match.split(':')[1].toUpperCase()}</span>`);

  texto = texto.replace(/(INDICE\s+DE\s+RADIACION\s+ULTRAVIOLETA\s*:\s*[0-9\-]+.*)/gi, 
      (match) => `<span class="negrita">INDICEDERADIACIONULTRAVIOLETA:${match.split(':')[1].toUpperCase()}</span>`);

  return texto;
}

function aplicarFormatoHTML(texto){
  let html = texto;
  html = html.replace(/\b(Lunes|Martes|Mi칠rcoles|Miercoles|Jueves|Viernes|S치bado|Sabado|Domingo)\s+\d{1,2}(\s+de\s+\w+)?\.?/gi,
    match => `<div class="dia-semana"><b><u>${capitalizarFrase(match.replace(/\./g,"").trim())}</u></b></div>`);

  html = html.replace(/\bSITUACION SINOPTICA:?[\s\n]*/gi,'<div class="bloque-seccion"><span class="titulo-seccion">Situaci칩n Sin칩ptica:</span>');
  html = html.replace(/\bPRONOSTICO:?[\s\n]*/gi,'</div><div class="bloque-seccion"><span class="titulo-seccion">Pron칩stico:</span>');

  html += '</div>';
  html = html.replace(/\n{2,}/g,'\n');
  html = html.replace(/\n/g,'<br>');
  return html;
}

function generarVista(){
  const texto = document.getElementById("textoInforme").value.trim();
  if(!texto){ alert("Por favor, pega el texto del informe meteorol칩gico."); return; }

  const lineas = texto.split("\n");
  const encabezado = lineas.slice(0,2).map(l => `<div class="encabezado-principal">${l}</div>`).join("");
  const libres = lineas.slice(2,5).map(l => `<div class="parrafo-libre">${l}</div>`).join("");
  const resto = lineas.slice(5).join("\n");

  const textoProcesado = formatearTexto(resto);
  const htmlFormateado = aplicarFormatoHTML(textoProcesado);

  document.getElementById("vistaPrevia").innerHTML = `${encabezado}${libres}<br>${htmlFormateado}`;
}

async function generarPDF(){
  const { jsPDF } = window.jspdf;
  const vista = document.getElementById("vistaPrevia");
  const canvas = await html2canvas(vista,{scale:2, backgroundColor:"#ffffff"});
  const imgData = canvas.toDataURL("image/png");
  const pdf = new jsPDF("p","mm","letter");
  const pageWidth = 216;
  const imgWidth = 210;
  const imgHeight = (canvas.height*imgWidth)/canvas.width;
  const nombreArchivo = document.getElementById("nombrePDF").value.trim() || "Informe_Meteorologico";
  pdf.addImage(imgData,"PNG",(pageWidth-imgWidth)/2,10,imgWidth,imgHeight);
  pdf.save(nombreArchivo+".pdf");
}

function reiniciar(){
  document.getElementById("textoInforme").value = "";
  document.getElementById("vistaPrevia").innerHTML = "";
  document.getElementById("nombrePDF").value = "";
}
</script>
</body>
</html>
